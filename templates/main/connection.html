{% extends 'main/base.html' %}

{% block navbar %}
<form onsubmit="event.preventDefault();">
    <a href="#connection" class="nav-item nav-link active"><i class="fa fa-tachometer-alt me-2"></i>Connection</a>
    <a href="#queryhelper" class="nav-item nav-link"><i class="fa fa-th me-2"></i>query helper</a>
    <a href="#visualization" class="nav-item nav-link"><i class="fa fa-chart-bar me-2"></i>visualization</a>
    <a href="{% url 'history' %}" class="nav-item nav-link"><i class="fa fa-table me-2"></i>History</a>
    <a href="{% url 'how_to_use' %}" class="nav-item nav-link"><i class="fa fa-keyboard me-2"></i>how to use</a>
</form>
{% endblock %}

{% block content %}
<!-- ====================== STYLES ====================== -->
<style>
    /* Base styles */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    
    /* Scroll container styles */
    .scroll-container {
        height: 100vh;
        overflow-y: auto;
        scroll-snap-type: y mandatory;
        scroll-behavior: smooth;
        position: relative;
    }
    
    /* Section styles */
    .section {
        height: 100vh;
        scroll-snap-align: start;
        position: relative;
        overflow-y: auto;
        padding: 20px;
    }

    /* Navigation styles */
    .nav-item.active {
        color: #0d6efd !important;
        font-weight: bold;
    }

    /* Container styles */
    .container-fluid {
        height: 100%;
    }

    /* Error and loading states */
    .error-message {
        color: red;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid red;
        display: none;
    }
    .loading {
        display: none;
        padding: 20px;
        text-align: center;
    }
</style>

<!-- ====================== EXTERNAL DEPENDENCIES ====================== -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ====================== MAIN CONTENT ====================== -->
<div class="scroll-container">
    <!-- Connection Section -->
    <div id="connection" class="section">
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-sm-12">
            <div class="bg-light rounded h-100 p-4">
                <h6 class="mb-4">Select Input Type</h6>
                <form onsubmit="event.preventDefault(); sendInputType()">
                <div class="form-floating mb-3">
                    {% csrf_token %}
                    <select class="form-select" id="inputType"
                                aria-label="Floating label select example">
                        <option selected>Select Input Type</option>
                        <option value="postgres">postgres</option>
                        <option value="mysql">mysql</option>
                        <option value="mongoDB">mongoDB</option>
                        <option value="pandas">csv,excel,json</option>
                    </select>
                </div>
                <div class="m-n2">
                    <button type="submit" class="btn btn-primary m-2">Confrim</button>
                    <button type="button" onclick="initFirstHandler()" class="btn btn-primary m-2">load database</button>
                 </div>
                </form>
                <div id="responseMessage"></div>
            </div>
        </div>
        <div class="col-sm-12 " id="dbOption">
            <div class="bg-light rounded h-100 p-4">
                <h6 class="mb-4">Databases</h6>
                <form onsubmit="event.preventDefault()">
                    <div class="form-floating mb-3">
                        <select class="form-select" id="floatingSelect"
                            aria-label="Floating label select example">
                            <option selected id="result">select databases</option>
                            <option value="1">One</option>
                            <option value="2">Two</option>
                            <option value="3">Three</option>
                        </select>
                    </div>
                    <div class="m-n2">
                    <button  id="dbSubmit" type="submit" class="btn btn-primary m-2">Confrim</button>
                    <button onclick="initSecondHandler()" class="btn btn-success m-2">Load Tabel</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-sm-12 " id="tableOption">
            <div class="bg-light rounded h-100 p-4">
                <h6 class="mb-4">select tabel</h6>
                <form onsubmit="event.preventDefault()">
                    <div class="form-floating mb-3">
                        <select class="form-select" id="floatingSelect_1"
                            aria-label="Floating label select example">
                            <option selected id="result1">select tabel</option>
                            <option value="1">One</option>
                            <option value="2">Two</option>
                            <option value="3">Three</option>
                        </select>
                    </div>
                    <div class="m-n2">
                        <button id="tbSubmit" type="submit" class="btn btn-primary m-2">Confrim</button>
                        <button id="loadData" class="btn btn-success m-2">Load Sample</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-12">
            <div class="bg-light rounded h-100 p-4">
                <h6 class="mb-4">Sample Table</h6>
                <div class="table-responsive">
                    <table class="table" id="dataTable">
                    </table>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- Query Helper Section -->
    <div id="queryhelper" class="section">
        <div class="col-12">
            <div class="bg-light rounded h-100 p-4">
               <div class="row row-demo-grid">
                   <div class="col-6 col-md-4">
                    <h6 class="mb-4">Query Helper</h6>
                    </div>
                    <div class="col-12 col-md-8 text-center" id="query_submit">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="bg-light rounded h-100 p-4">
               <div class="row row-demo-grid">
                   <div class="col-12 col-md-8 text-start" id="generated_query" >
                    </div>
                    <div class="col-6 col-md-4">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="bg-light rounded h-100 p-4">
                <h6 class="mb-4" id="retrieved_data"></h6>
                <div class="table-responsive">
                    <table class="table" id="dataTable">
                    </table>
                </div>
            </div>
        </div>
        <div class="container-fluid pt-4 px-4 ">
            <div class="bg-light rounded-top p-4 ">      
                <div class="row">
                    <div class="form-floating">
                        <form onsubmit="event.preventDefault(); handleQuerySubmit();">
                            {% csrf_token %}
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control border-0" 
                                   id="queryInput" 
                                   placeholder="Enter your query"
                                   autocomplete="off"
                                   style="background: transparent;">
                            <button class="btn btn-link" type="submit" id="submit-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="c  .urrentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                                    <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                                </svg>
                            </button>
                        </div>
                    </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualization Section -->
    <div id="visualization" class="section">
        <div class="container-fluid pt-4 px-4">
            <div class="row g-4">
                <div class="col-12">
                    <div class="bg-light rounded h-100 p-4">
                        <h6 class="mb-4">Visualization Section</h6>
                        <!-- Visualization content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ====================== MODALS ====================== -->
<div class="modal fade" id="postgresModal" tabindex="-1" aria-labelledby="inputModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inputModalLabel">Postgres</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="event.preventDefault(); sendPostgresParameters()">
            {% csrf_token %}
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-sm-12 col-xl-6">
                        <label for="userInput" class="form-label">user</label>
                        <input type="text" class="form-control" id="postgresUser" placeholder="">
                        <label for="userInput" class="form-label">password</label>
                        <input type="text" class="form-control" id="postgresPassword" placeholder="">
                    </div>
                    <div class="col-sm-12 col-xl-6">
                        <label for="userInput" class="form-label">Host</label>
                        <input type="text" class="form-control" id="postgresHost" placeholder="">
                        <label for="userInput" class="form-label">Port</label>
                        <input type="text" class="form-control" id="postgresPort" placeholder="">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" >connect</button>
            </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="mysqlModal" tabindex="-1" aria-labelledby="inputModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inputModalLabel">MYSQL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="event.preventDefault(); sendMysqlParameters()">
            {% csrf_token %}
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-sm-12 col-xl-6">
                        <label for="userInput" class="form-label">user</label>
                        <input type="text" class="form-control" id="mysqlUser" placeholder="">
                        <label for="userInput" class="form-label">password</label>
                        <input type="text" class="form-control" id="mysqlPassword" placeholder="">
                    </div>
                    <div class="col-sm-12 col-xl-6">
                        <label for="userInput" class="form-label">Host</label>
                        <input type="text" class="form-control" id="mysqlHost" placeholder="">
                        <label for="userInput" class="form-label">Port</label>
                        <input type="text" class="form-control" id="mysqlPort" placeholder="">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" >connect</button>
            </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="mongodbModal" tabindex="-1" aria-labelledby="inputModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inputModalLabel">MongoDB</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="event.preventDefault(); sendURL()">
            {% csrf_token %}
            <div class="modal-body">
                <label for="userInput" class="form-label">MongoDB url:</label>
                <input type="url" class="form-control" id="mongodbUrl" placeholder="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" >connect</button>
            </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="inputModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inputModalLabel">File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="event.preventDefault(); sendFile()">
            <div class="modal-body">
                <label for="userInput" class="form-label">CSV,Excel,JSON:</label>
                <input type="file" class="form-control" id="fileInput" placeholder="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" >connect</button>
            </div>
            </form>
        </div>
    </div>
</div>

<!-- ====================== JAVASCRIPT ====================== -->
<script>
    // ===== Infinite Scroll and Navigation =====
    document.addEventListener('DOMContentLoaded', function() {
        const sections = document.querySelectorAll('.section');
        const navLinks = document.querySelectorAll('.nav-item');
        const scrollContainer = document.querySelector('.scroll-container');
        
        // Handle scroll events
        let isScrolling = false;
        
        function updateActiveSection() {
            const scrollPosition = scrollContainer.scrollTop;
            const sectionHeight = window.innerHeight;
            const currentSection = Math.floor(scrollPosition / sectionHeight);
            
            // Update navigation
            navLinks.forEach((link, index) => {
                if (index === currentSection) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
        
        // Initial update
        updateActiveSection();
        
        // Throttle scroll events
        scrollContainer.addEventListener('scroll', function() {
            if (!isScrolling) {
                window.requestAnimationFrame(function() {
                    updateActiveSection();
                    isScrolling = false;
                });
                isScrolling = true;
            }
        });
        
        // Handle navigation clicks
        navLinks.forEach((link, index) => {
            link.addEventListener('click', function(e) {
                const href = link.getAttribute('href');
                
                // Check if it's a regular URL (not a hash link)
                if (!href.startsWith('#')) {
                    // Allow the default navigation for regular URLs
                    return true;
                }
                
                // Handle hash links for infinite scroll
                e.preventDefault();
                const targetPosition = index * window.innerHeight;
                scrollContainer.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
            });
        });
    });

    // ===== Query Helper Functions =====
    const queryInput = document.getElementById('queryInput');
    
    // Handle Enter key press
    queryInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleQuerySubmit();
        }
    });

    // Handle query submission
    function handleQuerySubmit() {
        const queryInput = document.getElementById('queryInput');
        const submitButton = document.getElementById('submit-button');
        const generatedQueryElement = document.getElementById('generated_query');
        const query = queryInput.value.trim();
    
        if (query) {
            // Disable input during submission
            queryInput.disabled = true;
            submitButton.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Sending...
            `;
            document.getElementById('query_submit').innerHTML = `
                <div class="alert alert-primary" role="alert">
                    <code class="text-dark text-wrap ">${query}</code>
                </div>
            `;
            
            // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
            // Send API request
            fetch('/query_response/', {
        method: 'POST',
        headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ query: query })
    })
    .then(response => {
        if (!response.ok) {
                    throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
                // Clear input
                queryInput.value = '';
                
                // Display response
                generatedQueryElement.innerHTML = `
                    <div class="alert alert-success" role="alert">
                        <code class="text-dark text-wrap ">${data.message}</code>
                    </div>
                `;
                
                // Reset button
                submitButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                        <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                    </svg>
                `;
        })
        .catch(error => {
            console.error('Error:', error);
                generatedQueryElement.innerText = 'An error occurred. Please try again.';
                submitButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                        <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                    </svg>
                `;
            })
            .finally(() => {
                queryInput.disabled = false;
                loadTableData();
            });
        }
    }
    
    // ===== Data Table Functions =====
    function loadTableData() {
        const retrievedDataElement = document.getElementById('retrieved_data');
        
        // Properly check and destroy existing DataTable
        if ($.fn.DataTable.isDataTable('#dataTable')) {
        $('#dataTable').DataTable().destroy();
        }
        
    $('#loading').show();
    $('#errorMessage').hide();
    
    return $.ajax({
            url: '/get-dataframe/',
        method: 'GET',
        success: function(response) {
            if (response.error) {
                $('#errorMessage').text(response.error).show();
                return;
            }
                
                retrievedDataElement.innerHTML = `Retrieved data from database`;
                
            // Clear the table HTML
            $('#dataTable').empty();
            
            // Initialize DataTable and store reference
            window.dataTable = $('#dataTable').DataTable({
                data: response.data,
                columns: response.columns,
                dom: 'Bfrtip',
                buttons: ['copy', 'csv', 'excel'],
                pageLength: 10,
                responsive: true,
                ordering: true,
                searching: true
            });
        },
        error: function(xhr, status, error) {
            $('#errorMessage').text('Error loading data: ' + error).show();
        },
        complete: function() {
            $('#loading').hide();
        }
    });
    }
</script>
{% endblock %}